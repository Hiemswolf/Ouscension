<!doctype html>
<html>
  <head>
    <title>Spacy.io</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; background-color: #00ff00; overflow: hidden;}
      #PlayBtn { border: 0; padding: 10px; width: 10%; margin-left: 45%; margin-top: 35%; position: absolute;
        background-color: rgb(130, 224, 255); font-size: 20px;}
      #usr { border: 0; padding: 10px; width: 8%; margin-left: 46%; margin-top: 30%;
        background-color: rgb(200,200,200); position: absolute; font-size: 20px;}
      #TextHolder {position: absolute; width: 100%;}
      #Title {position: absolute; text-align: center; width: 100%; margin-top: 10%; font-size: 120px;}
      .player {background-image: url('https://preview.ibb.co/g8db9b/Character_Purple_Right.gif'); width: 40px; height: 40px;
        position: absolute; color: white; text-align: center; background-size: 100% 100%;}
      .bullet {width: 5px; height: 5px; background: #00ff00; position: absolute;}
      .crate {width: 25px; height: 25px; background-image: url('https://preview.ibb.co/dsQdNw/Box.gif'); position: absolute;}
      p,h1 {font-family: arial; position: absolute; z-index: 1000000}

    </style>
  </head>
  <body>
    <h1 id="health" style="color: white;"></h1>
    <h1 id="level" style="color: white; margin-top: 30px;"></h1>
    <h1 id="score" style="color: white; margin-top: 60px;"></h1>
    <div id="background" style="width: 1280px; height: 640px; position: absolute;"></div>
    <div id="playerContainer"></div>
    <div id="bulletContainer"></div>
    <div id="crateContainer"></div>
    <p id="Title">Spacy.io</p>
    <div id="TextHolder">
      <p>Controls:<br>Space: Switch direction<br>W,A,S,D: Normal movement</p>
      <p style="margin-left: 42%; margin-top: 20%; font-size: 20px;">Created by: Luke Mueller</p>
    </div>
    <form action="" id="CharChoose">
      <input value="User" id="usr" autocomplete="off" />
      <button id="PlayBtn">Play</button>
    </form>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      $(function () {

        var socket = io();
        var gameStart = false;
        var createdSelf = false;

          //Before Game
          $('form').submit(function(){
            if($('#usr').val() !== '' || null && $('#usr').val().length <= 24) {
              document.getElementById('background').style.backgroundImage = 'url("https://preview.ibb.co/fOWax6/Background.gif")';
              document.getElementById('background').style.repeat = 'no-repeat, no-repeat';
              document.getElementById('background').style.backgroundSize = '1280px 640px';

              socket.emit('createChar', $('#usr').val());

              $('#Title').remove();
              $('#CharChoose').remove();
              $('#TextHolder').remove();

              gameStart = true;
            }
            return false;
          });



          //Varibles for Game
          var player = new Object();
          player.x = Math.floor(Math.random() * 1240);
          player.y = Math.floor(Math.random() * 600);
          player.moveSpeed = 5;
          if(Math.floor(Math.random() * 2) == 1) {player.mainDir = 'right';}
          else {player.mainDir = 'left';}
          player.w = 40;
          player.h = 40;
          player.bulletShootSpeed = 25;
          player.bulletTimer = 15;
          player.maxHp = 30;
          player.hp = 30;
          player.score = 0;
          player.healCounter = 50;
          player.healTimer = 50;
          player.bulletLife = 40;

          var damager;

          var wKey = 87;
          var aKey = 65;
          var sKey = 83;
          var dKey = 68;
          var spaceKey = 32;

          var controller = new Object();

          var bullets = new Array();
          var crates = new Array();

          //Controlls for game
          document.onkeydown = function(evt) {
                toggleKey(evt.keyCode, true)
            };
            document.onkeyup = function(evt) {
                toggleKey(evt.keyCode, false)
            };
            function toggleKey(keyCode, isPressed) {
                if(keyCode == wKey) {
                    controller.w = isPressed;
                }
                if(keyCode == aKey) {
                    controller.a = isPressed;
                }
                if(keyCode == sKey) {
                    controller.s = isPressed;
                }
                if(keyCode == dKey) {
                    controller.d = isPressed;
                }
                if(keyCode == spaceKey && isPressed) {
                  if(player.mainDir === 'right') {player.mainDir = 'left'}
                  else {player.mainDir = 'right'}
                }
            }

          //During Game
          socket.on('loadNewChar', function(usr, value) {
          if(gameStart === true) {
            if(createdSelf === false) {
              createdSelf = true;
              player.element = value;
              player.name = usr;
            }
            var element = document.createElement('div');
            element.className = 'player';
            element.innerHTML = usr;
            element.id = value;
            element.style.left = '-50px';
            element.style.top = '-50px';
            document.getElementById('playerContainer').appendChild(element);
          }
          });

          socket.on('deleteChar', function(value){
          if(gameStart === true) {
            var element = value;
            document.getElementById(element).style.display = 'none';
            document.getElementById(element).parentNode.removeChild(element);
          }
          });

          socket.on('kill', function(killer){
          if(gameStart && killer === player.element) {
            player.score += 10;
          }
          });

          socket.on('getPlayer', function(){
          if(gameStart === true) {
            if(controller.w) {player.y -= player.moveSpeed;}
            if(controller.a) {player.x -= player.moveSpeed;}
            if(controller.s) {player.y += player.moveSpeed;}
            if(controller.d) {player.x += player.moveSpeed;}
            if(player.mainDir === 'right') {player.x += player.moveSpeed * 2}
            if(player.mainDir === 'left') {player.x -= player.moveSpeed * 2}
            if(player.x < 0) {player.x = 1280 - player.w}
            if(player.y < 0) {player.y = 640 - player.h}
            if(player.x + player.w > 1280) {player.x = 0}
            if(player.y + player.h > 640) {player.y = 0}

            player.bulletTimer--;
            if(player.bulletTimer <= 0) {
              player.bulletTimer = player.bulletShootSpeed;

              var bulletY = player.y + player.h/2 + 2;

              if(player.mainDir == 'right') {var bulletX = player.x + player.w/2 + 6;}
              else {var bulletX = player.x - player.w/2 - 6;}

              socket.emit('newBullet', bulletX, bulletY, player.mainDir, player.element, player.bulletLife);
            }

            socket.emit('receivePlayer', player.x, player.y, player.element, player.name, player.mainDir);
          }
          });

          socket.on('loadNewBullet', function(x, y, dir, value, owner, life) {
          if(gameStart === true) {
            var element = document.createElement('div');
            element.className = 'bullet';
            element.id = value;
            element.style.left = x;
            element.style.top = y;

            var bullet = new Object();
            bullet.x = x;
            bullet.y = y;
            bullet.dir = dir;
            bullet.w = 5;
            bullet.h = 5;
            bullet.element = value;
            bullet.life = life;
            bullet.delete = false;
            bullet.owner = owner;

            bullets[bullets.length] = bullet;
            document.getElementById('bulletContainer').appendChild(element);
            if(bullet.owner === player.element) {
            document.getElementById(bullet.element).style.backgroundColor = '#00ffff';
            }
          }
          });

          socket.on('newCrate', function(value, x, y) {
            if(gameStart) {
              var element = document.createElement('div');
              element.className = 'crate';
              element.id = value;
              element.style.left = x;
              element.style.top = y;

              var crate = new Object();
              crate.x = x;
              crate.y = y;
              crate.w = 25;
              crate.h = 25;
              crate.element = value;
              crate.life = 40;
              crate.delete = false;
              crate.hp = 1;

              crates[crates.length] = crate;
              document.getElementById('crateContainer').appendChild(element);

              document.getElementById(crate.element).style.left = crate.x + 'px';
              document.getElementById(crate.element).style.top = crate.y + 'px';
            }
          });

          socket.on('showPlayer', function(x, y, value, name, dir){
          if(gameStart === true && value !== null) {
            if($("#" + value).length == 0) {
              var element = document.createElement('div');
              element.className = 'player';
              element.innerHTML = name;
              element.id = value;
              document.getElementById('playerContainer').appendChild(element);
            }
            document.getElementById(value).style.left = x + 'px';
            document.getElementById(value).style.top = y + 'px';
            if(dir == 'right') {document.getElementById(value).style.backgroundImage = "url('https://preview.ibb.co/g8db9b/Character_Purple_Right.gif')"}
            if(dir == 'left') {document.getElementById(value).style.backgroundImage = "url('https://preview.ibb.co/m8nshw/Character_Purple_Left.gif')"}
          }
          });

          socket.on('loop', function() {if(gameStart) {
            if($("#null").length > 0) {
              var element = document.getElementById('null');
              element.style.display = 'none';
              element.parentNode.removeChild(element);
            }

            for(i = 0; i < bullets.length; i++) {
              bullets[i].life--;

              if(bullets[i].dir == 'right') {bullets[i].x += 20}
              else {bullets[i].x -= 20}

              document.getElementById(bullets[i].element).style.left = bullets[i].x + 'px';
              document.getElementById(bullets[i].element).style.top = bullets[i].y + 'px';

              if(bullets[i].x < 0) {bullets[i].x = 1280 - bullets[i].w}
              if(bullets[i].x + bullets[i].w > 1280) {bullets[i].x = 0}

              if(bullets[i].life <= 0) {bullets[i].delete = true;}
              if(checkCollision(bullets[i], player) && bullets[i].owner !== player.element) {bullets[i].delete = true; player.hp -= 10; damager = bullets[i].owner;}

              for(j = 0; j < crates.length; j++) {
                if(checkCollision(bullets[i], crates[j])) {
                  bullets[i].delete = true;
                  crates[j].hp--;
                  if(crates[j].hp <= 0) {
                    if(bullets[i].owner == player.element) {player.score += 1}
                    var element = document.getElementById(crates[j].element);
                    element.style.display = 'none';
                    element.parentNode.removeChild(element);
                    crates = removeElements(crates, j);
                    j--;
                  }
                }
              }

              if(bullets[i].delete) {
                var element = document.getElementById(bullets[i].element);
                element.style.display = 'none';
                element.parentNode.removeChild(element);
                bullets = removeElements(bullets, i);
                i--;
              }
            }
            var level = Math.floor(player.score / 5);

            document.getElementById('health').innerHTML = 'HP: ' + player.hp;
            document.getElementById('level').innerHTML = 'Level: ' + level;
            document.getElementById('score').innerHTML = 'Score: ' + player.score;

            player.maxHp = 30 + level * 2;
            player.bulletLife = 40 + level * 2.5;
            player.bulletShootSpeed = 25 - level / 5;

            if(player.hp <= 0) {
              socket.emit('dead', damager);
              gameStart = false;
            }
            player.healTimer--;
            if(player.healTimer <= 0 && player.hp < player.maxHp) {
              player.healTimer = player.healCounter;
              player.hp++;
            }
          }
          });

function checkCollision (a,b) {
  return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
}

function removeElements(array, index){
    var tempArray = new Array();
    var counter = 0;

    for(var i = 0; i < array.length; i++){
        if(i != index){
            tempArray[counter] = array[i];
            counter++;
        }
    }
    return tempArray;
}
      });
    </script>
  </body>
</html>
