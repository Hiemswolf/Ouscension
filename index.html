<!doctype html>
<html>
  <head>
    <title>Ouscension</title>
    <style>
      .player {
                width: 25px;
                height: 25px;
                background: #00ffff;
                position: absolute;
                z-index: 1000000;
      }
      .bullet {
                width: 10px;
                height: 5px;
                background: #00ff00;
                position: absolute;
                z-index: 10;
      }
      .portal {
                width: 30px;
                height: 30px;
                background: #000000;
                color: rgb(200, 200, 200);
                position: absolute;
                z-index: 5;
      }
    </style>
  </head>
  <body>
    
    <div id="playerContainer"></div>
    <div id="bulletContainer"></div>
    <div id="portalContainer"></div>
    
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      $(function () {
        
        var socket = io();
        var createdSelf = false;
        
        socket.emit('createChar');
        
        var wKey = 87;
        var aKey = 65;
        var sKey = 83;
        var dKey = 68;
        
        var eKey = 69;
        
        var controller = new Object();
        
            var screenX = 0;
            var screenY = 0;
            if(true) {
                var w = window;
                d = document;
                e = d.documentElement;
                g = d.getElementsByTagName('body')[0];
                x = w.innerWidth || e.clientWidth || g.clientWidth;
                y = w.innerHeight|| e.clientHeight|| g.clientHeight;
                screenX = x;
                screenY = y;
            }
        
        var player = new Object();
          player.x = 0;
          player.y = 0;
          player.moveSpeed = 20;
          player.w = 25;
          player.h = 25;
          player.world = 'Hub';
        
        var portals = [];
        
        
        
        function checkCollision (a,b) {
                return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
            }
            function createSprite(element, x, y, w, h) {
                var result = new Object();
                result.element = element;
                result.x = x;
                result.y = y;
                result.w = w;
                result.h = h;
              
                return result;
            }
        function setPosition(sprite) { if(createdSelf) {
          var e = document.getElementById(sprite.element);
          
          if(player.world === sprite.world) {
              e.style.left = sprite.x - player.x + screenX / 2 + "px";
              e.style.top = sprite.y - player.y + screenY / 2 + "px";
              e.style.display = 'block';
          } else {
            e.style.display = 'none';
          }
        }}
            document.onkeydown = function(evt) {
                toggleKey(evt.keyCode, true);
              if(evt.keyCode == eKey) {
                for(i = 0; i < portals.length; i++) {
                  if(portals[i].world === player.world) {
                    if(checkCollision(player, portals[i])) {
                      player.world = portals[i].teleport;
                      player.x = 0;
                      player.y = 0;
                    }
                  }
                }
              }
            };
            document.onkeyup = function(evt) {
                toggleKey(evt.keyCode, false)
            };
            function toggleKey(keyCode, isPressed) {
                if(keyCode == wKey) {
                    controller.w = isPressed;
                }
                if(keyCode == aKey) {
                    controller.a = isPressed;
                }
                if(keyCode == sKey) {
                    controller.s = isPressed;
                }
                if(keyCode == dKey) {
                    controller.d = isPressed;
                }
            }
            function handleControls() {
                if(controller.w) {
                    player.y -= player.moveSpeed;
                }
                if(controller.a) {
                    player.x -= player.moveSpeed;
                }
                if(controller.s) {
                    player.y += player.moveSpeed;
                }
                if(controller.d) {
                    player.x += player.moveSpeed;
                }
            }
        
        document.onmousemove = function(evt) {
          var angle = Math.atan2((evt.y - screenY / 2), (evt.x - screenX / 2)) * (180 / Math.PI);
          player.angle = angle;
        };
        
            socket.on('loadNewChar', function(value) {
              
                var element = document.createElement('div');
                element.className = 'player';
                //element.innerHTML = usr;
                element.id = value;
                element.style.left = '-50px';
                element.style.top = '-50px';
              
                if(createdSelf === false) {
                  createdSelf = true;
                  player.element = value;
                  
                  element.style.left = screenX / 2 + 'px';
                  element.style.top = screenY / 2 + 'px';
                }
              
                document.getElementById('playerContainer').appendChild(element);
              });
        
            socket.on('showPlayer', function(value, x , y, angle){
          if(createdSelf && value !== null) {
            if($("#" + value).length == 0) {
              var element = document.createElement('div');
              element.className = 'player';
              //element.innerHTML = name;
              element.id = value;
              document.getElementById('playerContainer').appendChild(element);
            }
            if(player.element != value) {
              var element = document.getElementById(value);
              element.style.left = x - player.x + screenX / 2 + "px";
              element.style.top = y - player.y + screenY / 2 + "px";
            }
            document.getElementById(value).style.transform = "rotate(" + angle + "deg)";
          }
          });
        
        document.onmousedown = function(evt) {
          if(evt.which === 1) {
            socket.emit('createBullet', player);
          }
        }
        
        function bulletHandler(bullets) {
          for(i = 0; i < bullets.length; i++) {
            
            if(createdSelf && bullets[i].element !== null) {
              if($("#" + bullets[i].element).length == 0) {
                var element = document.createElement('div');
                element.className = 'bullet';
                element.id = bullets[i].element;
                element.style.transform = 'rotate(' + bullets[i].angle + 'deg)';
                document.getElementById('bulletContainer').appendChild(element);
              }
            }
            
            if(bullets[i].lifeTimer < 0) {
              var element = document.getElementById(bullets[i].element);
              if(element !== null) {
                element.style.display = "none";
                element.parentNode.removeChild(element);
              }
            } else {
              setPosition(bullets[i]);
            }
          }
        },
        
        function portalHandler() {
          for(i = 0; i < portals.length; i++) {
            
            if(createdSelf && portals[i].element !== null) {
              if($("#" + portals[i].element).length == 0) {
                var element = document.createElement("div");
                element.className = "portal";
                element.id = portals[i].element;
                element.innerHTML = portals[i].teleport;
                element.style.left = '-50px';
                element.style.top = '-50px';
                document.getElementById('portalContainer').appendChild(element);
              }
            }
            
            setPosition(portals[i]);
          }
        }
        
        
        
            //Update
            socket.on('loop', function(bullets, portalsSetter) {
              portals = portalsSetter;
              
              handleControls();
              bulletHandler(bullets);
              portalHandler();
              
              socket.emit('playerInfo', player.element, player.x, player.y, player.angle)
            });
        
        document.addEventListener("contextmenu", function(e){
          e.preventDefault();
        }, false);
        
      });
    </script>
  </body>
</html>
